---
import Layout from "../../layouts/Layout.astro";
import { getEntries } from "astro:content";
import { getCollection } from "astro:content";

const posts = await getCollection("posts");

const authorsPerPost = await Promise.all(
  posts.map(async (post) => {
    const authors = await getEntries(post.data.authors);

    return {
      postId: post.id,
      authors,
    };
  }),
);

const cardData = posts.map((post) => ({
  url: `/posts/${post.id}`,
  title: post.data.title,
  description: post.data.description,
  pubDate: post.data.pubDate,
  authors: authorsPerPost
    .find((a) => a.postId === post.id)
    ?.authors.map((author) => author.data.name) || [],
}));
---

<Layout>
    {cardData.length === 0 && (
        <div class="flex flex-col items-center justify-center py-20">
            <span class="text-2xl text-gray-400">No posts found.</span>
        </div>
    )}

    { 
        cardData.length > 0 && (
            <div class="flex flex-col items-center py-5">
            {
                cardData.map((post) => (
                <div class="border-2 border-primary-light rounded-md p-4 max-w-200 w-full">
                    <span class="text-2xl font-semibold text-primary-light">
                        {post.title}
                    </span>
        
                    <p class="my-5">{post.description}</p>
        
                    <div class="flex justify-between w-full">
                        <a href={post.url} class="text-primary-light hover:underline underline-offset-8">
                            Read full article >>
                        </a>
        
                        <span class="text-sm text-gray-400">
                            {new Date(post.pubDate).toLocaleDateString()} | {post.authors.join(", ")}
                        </span>
                    </div>
                </div>
                ))
            }
            </div>
        )
    }
</Layout>
